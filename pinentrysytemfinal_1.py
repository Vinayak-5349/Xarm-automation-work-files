import time
import json
from xarm.wrapper import XArmAPI

xarm_ip = "192.168.1.183"
arm = XArmAPI(xarm_ip)
arm.connect()
arm.clean_error()
arm.clean_warn()
arm.motion_enable(enable=True)
arm.set_mode(0)
arm.set_state(0)

PIN_STEP_FILE = "PIN_STEPS_SYSTEM1.json"
recorded_sequence = {}

def record_step(step_type, data, delay):
    step = {"type": step_type, "delay": delay}
    step.update(data)
    recorded_sequence["current"].append(step)

def timed_call(step_type, data, func, *args, **kwargs):
    start = time.time()
    func(*args, **kwargs)
    delay = time.time() - start
    record_step(step_type, data, delay)

def timed_sleep(duration):
    time.sleep(duration)
    record_step("sleep", {"duration": duration}, duration)

def move_to_cartesian(pos, speed):
    status, joints = arm.get_inverse_kinematics(
        pos, input_is_radian=False, return_is_radian=False
    )
    if status == 0 and joints:
        joints = [float(j) for j in joints[:6]]
        timed_call(
            "move",
            {"joints": joints, "speed": speed},
            arm.set_servo_angle,
            angle=joints,
            speed=speed,
            is_radian=False,
            wait=True
        )

def record_entry():
    recorded_sequence["current"] = []
    move_to_cartesian([-12.2,246,170.6,-152.3,0.7,1.5], 95)
    move_to_cartesian([-327.3,152.8,266.4,-179.3,-0.3,87.9], 95)
    move_to_cartesian([-327.3,152.8,126.1,-179.3,-0.3,87.9], 95)
    return recorded_sequence["current"]

def record_exit():
    recorded_sequence["current"] = []
    move_to_cartesian([-327.3,152.8,126.1,-179.3,-0.3,87.9], 95)
    move_to_cartesian([-327.3,152.8,266.4,-179.3,-0.3,87.9], 95)
    move_to_cartesian([-12.2,246,170.6,-152.3,0.7,1.5], 95)
    return recorded_sequence["current"]

def record_button(name, steps):
    recorded_sequence["current"] = []
    for pos in steps:
        move_to_cartesian(pos[:6], pos[6])
        if pos[6] == 10:
            timed_sleep(0.2)
    return recorded_sequence["current"]

def main():
    step_data = {}

    print("[INFO] Recording ENTRY...")
    step_data["entry"] = record_entry()

    button_coords = {

        "1": [
            [-350.5,172.3,110.3,-179.3,-0.3,87.9,50],
            [-350.5,172.4,104.2,-179.3,-0.3,87.9,10],
            [-350.5,172.3,110.3,-179.3,-0.3,87.9,50],
        ],

        "2": [
            [-330.1,172.8,110.1,-179.3,-0.3,87.9,50],
            [-330.2,171.8,103.6,-179.3,-0.3,87.9,10],
            [-330.1,172.8,110.1,-179.3,-0.3,87.9,50],
        ],

        "3": [
            [-309,173,109.8,-179.3,-0.3,87.9,50],
            [-309.1,172.7,104.1,-179.3,-0.3,87.9,10],
            [-309,173,109.8,-179.3,-0.3,87.9,50],
        ],

        "4": [
            [-350.5,162.5,110.2,-179.3,-0.3,87.9,50],
            [-350.6,162.6,103.7,-179.3,-0.3,87.9,10],
            [-350.5,162.5,110.2,-179.3,-0.3,87.9,50],
        ],

        "5": [
            [-329.5,162.8,109.9,-179.3,-0.3,87.9,50],
            [-329.6,161.8,103.9,-179.3,-0.3,87.9,10],
            [-329.5,162.8,109.9,-179.3,-0.3,87.9,50],
        ],

        "6": [
            [-308.7,163,109.7,-179.3,-0.3,87.9,50],
            [-308.8,162.1,103.7,-179.3,-0.3,87.9,10],
            [-308.7,163,109.7,-179.3,-0.3,87.9,50],
        ],

        "7": [
            [-348,153.4,110.1,-179.3,-0.3,87.9,50],
            [-349.1,152.5,103.1,-179.3,-0.3,87.9,10],
            [-348,153.4,110.1,-179.3,-0.3,87.9,50],
        ],

        "8": [
            [-327.3,152.7,109.8,-179.3,-0.3,87.9,50],
            [-327.7,152.7,103.8,-179.3,-0.3,87.9,10],
            [-327.3,152.7,109.8,-179.3,-0.3,87.9,50],
        ],

        "9": [
            [-309.1,152,109.6,-179.3,-0.3,87.9,50],
            [-309.2,152,103.6,-179.3,-0.3,87.9,10],
            [-309.1,152,109.6,-179.3,-0.3,87.9,50],
        ],

        "0": [
            [-327.1,141.7,109.8,-179.3,-0.3,87.9,50],
            [-327.2,141.7,103.8,-179.3,-0.3,87.9,10],
            [-327.1,141.7,109.8,-179.3,-0.3,87.9,50],
        ],

        "backspace": [
            [-327.5,131,110.7,-179.3,-0.3,87.9,50],
            [-327.6,131,103.7,-179.3,-0.3,87.9,10],
            [-327.5,131,110.7,-179.3,-0.3,87.9,50],
        ],

        "ok": [
            [-309.6,132.3,110.5,-179.3,-0.3,87.9,50],
            [-309.7,132.4,103,-179.3,-0.3,87.9,10],
            [-309.6,132.3,110.5,-179.3,-0.3,87.9,50],
        ],

        "cancel": [
            [-351.2,132.3,111,-179.3,-0.3,87.9,50],
            [-351.3,132.3,103.3,-179.3,-0.3,87.9,10],
            [-351.2,132.3,111,-179.3,-0.3,87.9,50],
        ],

        "food": [
            [-366.8,212.7,121.4,-179.3,-0.3,87.9,50],
            [-367,212.8,109.4,-179.3,-0.3,87.9,10],
            [-366.8,212.7,121.4,-179.3,-0.3,87.9,50],
        ],

        "cash": [
            [-285.2,209.7,120.4,-179.3,-0.3,87.9,50],
            [-285.3,209.8,107.4,-179.3,-0.3,87.9,10],
            [-285.2,209.7,120.4,-179.3,-0.3,87.9,50],
        ],
                "10": [
            [-363.9,243.4,121.5,-179.3,-0.3,87.9,25],
            [-364,243.4,109,-179.3,-0.3,87.9,10],
            [-363.9,243.4,121.5,-179.3,-0.3,87.9,25],
        ],

        "20": [
            [-333.6,242.2,121.2,-179.3,-0.3,87.9,25],
            [-333.7,242.3,109.2,-179.3,-0.3,87.9,10],
            [-333.6,242.2,121.2,-179.3,-0.3,87.9,25],
        ],

        "30": [
            [-276.9,240.2,120.5,-179.3,-0.3,87.9,25],
            [-277.1,240.2,109.5,-179.3,-0.3,87.9,10],
            [-276.9,240.2,120.5,-179.3,-0.3,87.9,25],
        ],

        "40": [
            [-366.1,218.2,121.6,-179.3,-0.3,87.9,25],
            [-366.3,218.3,109.6,-179.3,-0.3,87.9,10],
            [-366.1,218.2,121.6,-179.3,-0.3,87.9,25],
        ],

        "50": [
            [-334.6,217.3,121.6,-179.3,-0.3,87.9,25],
            [-334.6,217.4,109.6,-179.3,-0.3,87.9,10],
            [-334.6,217.3,121.6,-179.3,-0.3,87.9,25],
        ],

        "other": [
            [-277.8,215.4,120.3,-179.3,-0.3,87.9,25],
            [-278,215.5,109.3,-179.3,-0.3,87.9,10],
            [-277.8,215.4,120.3,-179.3,-0.3,87.9,25],
        ]

    }

    step_data["buttons"] = {}
    for key, steps in button_coords.items():
        print(f"[INFO] Recording {key}")
        step_data["buttons"][key] = record_button(key, steps)

    print("[INFO] Recording EXIT...")
    step_data["exit"] = record_exit()

    with open(PIN_STEP_FILE, "w") as f:
        json.dump(step_data, f, indent=4)

    print("âœ… PIN steps saved")

if __name__ == "__main__":
    main()
